PV, PVC và VolumeExpansion
Dạo gần bên mình có triển khai các ứng dụng dạng StatefulSet cả trên Cloud lẫn On-Prem khá nhiều, trong đó vấn đề volume của sts hay deployment là khá quan trọng, volume đơn giản chỉ là RWO với 1 Pod thôi và nó chạy Replicate hoặc Cluster Sharding tùy loại ứng dụng hoặc database, tuy nhiên vấn đề chính trong khi triển khai sts với volume đó là Reclaim Policy và Volume Expansion.
Đầu tiên nắm rõ về PV và PVC trước, hôm nay mình có một anh đồng nghiệp hỏi về PV và PVC khác nhau như nào, sau đó mình đưa ra đáp án là PV sẽ tham chiếu đến disk hoặc volume ở bên phía provider, ví dụ AWS tạo ra một EBS thì cái volume trong EBS đó chính là cái PV, trong PV sẽ có tham số cho ta biết là ta đang dùng "volume nào của EBS". Vậy PV là tham chiếu tới volume của provider.
Còn PVC là gì ? Sang tới PVC, ta phải định nghĩa được rằng khi một volume được tạo ra, nó có thể được tạo ra nhờ vào PVC + StorageClass, sau đó từ StorageClass, CSI controller sẽ tạo ra PV tương ứng để tham chiếu tới cái volume thật ở bên ngoài provider, và PVC attach vào cái PV. Sau khi cả PV + PVC đều attach thì cuối cùng để PVC hoạt động thực sự, nó phải được attach vào Pod, PVC chứa thông tin về claim, chủ yếu bao gồm 2 thông tin, một là node selector, hai là Pod selector, có nghĩa là Pod nằm trên Node nào thì cái volume kia sẽ được attach vào node đó và đồng thời cũng attach được vào Pod đó luôn, đó chính là PVC.
Vậy hiểu đơn giản là PV tham chiếu tới volume ngoài provider. Còn PVC là tham chiếu tới volume gắn tới node nào và gắn vào vào pod nào trên node đó.
Tuy nhiên lúc sử dụng dynamic volume qua StorageClass, đây là cách phổ biến nhất vì dựa vào Cloud Provider và CSI thì ta chỉ cần điền các thông số trong PVC + StorageClass Name, các thông số về dung lượng, IOPS và FileSystem, but wait !!! PVC tham chiếu đến volume ở ngoài mà, tại sao lại tạo PVC và trỏ tới StorageClass là được luôn mà không phải tạo PV trước nhỉ ? Lại quay lại vấn đề ở trên, khi tạo PVC và chỉ định StorageClass thì StorageClass sẽ yêu cầu CSI tạo PV map với volume bên ngoài luôn.
=> Vậy thì Kubernetes chỉ quan tâm rằng nó tạo volume và volume claim như nào và đích cuối để mọi thứ hoạt động đó là volume phải được gắn vào Pod.
Kết luận trên có ý nghĩa như nào ? Let go to part 2 -> Volume Expansion
Đầu tiên để giải thích rõ thì ta sẽ scale sts về 0 trước để đảm bảo rằng lúc này Pod = 0 và volume cũng sẽ không được attach vào Node + Pod
PV có các trạng thái cần quan tâm là Released, Bound và Available, khi PV được tạo, được PVC attach thì nó đang được Bound, tuy nhiên trong trường hợp PVC bị unattach khỏi PV với điều kiện là StorageClass có Reclaim Policy = Retain, lúc này PV vẫn còn. PV gắn với volume thật bên ngoài, vậy suy ra volume thật vẫn còn, lúc này khi PVC bị unattach khỏi PV thì PV chuyển sang trạng thái Available.
Trong trạng thái này, ta có thể edit PV và resize nó và khi get lại thì nó đã update thành công và hiện dung lượng resize như mong muốn, ví dụ resize PV từ 6Gi lên 8Gi, tuy nhiên khi kiểm tra lại ngoài volume nó vẫn y nguyên và thậm chí chẳng có event nào được gửi đến Provider để request tăng dung lượng (capacity) lên cả.
Lúc này mình sẽ edit PV để xóa claim cũ và tạo lại PVC rồi gắn lại vào PVC đó sau đó resize tiếp PVC từ 6Gi lên 8Gi cho nó đồng bộ để xem volume ngoài có tăng không ? Oh shit, Kết quả là nó vẫn giữ nguyên và chưa tăng được .....
Sau khi scale sts về 0 Pod và tăng PV + PVC thì chúng đều không effect và chẳng có gì xảy ra cả, vậy nếu scale sts lại lên 1 thì lúc này PVC đã được "claim" lại tới Pod và Node chứa Pod đó, Tuy nhiên lúc này chúng có thể báo lỗi rằng PVC hiện tại không đồng nhất với PV hoặc nếu scale lại Pod lên được thì dung lượng vẫn y nguyên như vậy chẳng có gì xảy ra.
KẾT LUẬN
PV và PVC và Deployment/StatefulSet hoạt động chặt chẽ với nhau, mục đích chính sinh ra là để tạo ra volume cho Pod, Pod chỉ hiểu Volume đó nếu nó được gắn vào Disk, việc gắn vào Disk hay không là do PVC + Pod phải được up lên.
Tại sao scale lại không hoạt động khi PVC không attach vào Pod ? Bởi vì các Node trong Kubernetes chỉ hiểu volume khi nó được attach vào Node, Cloud Provider quản lý volume, và thể hiện trên Kubernetes qua resource là PV, PV chỉ tham chiếu rằng đến volume đó và có một cái liên quan tới StorageClass, nếu PV tạo ra từ StorageClass đó là Reclaim Policy, nghĩa là PV bị "zombie", không có PVC hoặc PVC gắn với nó bị xóa thì nó sẽ bị delete nếu policy = delete, còn không thì nó sẽ retain và nếu PV đang bị "zombie" thì nó sẽ "Availble" để thằng PVC khác "Bound" lại.
Suy ra PV chỉ thể hiện trạng thái của volume bên ngoài, dung lượng của nó phụ thuộc vào PVC.
Vì Volume trong Kubernetes phục vụ cho Pod, Pod thể hiện nó cần cái gì và cần từ đâu qua PVC, PVC thể hiện dung lượng cần từ volume ngoài (PV) và bên trong cho Pod, Khi PVC gắn vào một Pod đang chạy cũng đồng nghĩa với việc Volume được gắn vào Node, khi Volume gắn vào Node thì Kubernetes mới hiểu và mới quyết định hành động Volume Expansion, vì nó chỉ quản lý những gì có bên trong cụm, vậy nên người ta hay tăng PVC chứ không bao giờ tăng PV, vì PVC tham chiếu tới Volume gắn vào Node và Pod nên tăng dung lượng ở PVC mới có ý nghĩa thực sự.
Khi tăng PVC thì PV cũng sẽ tăng theo, điều đó có nghĩa rằng Cloud Provider phục vụ theo nhu cầu của Pod bên trong Kubernetes, nếu nó đang được attach vào volume và yêu cầu tăng, OK tôi sẽ tăng cho ông, tuy nhiên ông không được attach nhưng lại gửi yêu cầu tăng từ PV đang bị "zombie" tôi sẽ không tăng cho ông.
Phần này mình xin phép viết demo và sẽ có một bài deep dive sâu hơn để mọi người cùng hiểu, tạm viết draft trước như này đã 😃