PV, PVC vÃ  VolumeExpansion
Dáº¡o gáº§n bÃªn mÃ¬nh cÃ³ triá»ƒn khai cÃ¡c á»©ng dá»¥ng dáº¡ng StatefulSet cáº£ trÃªn Cloud láº«n On-Prem khÃ¡ nhiá»u, trong Ä‘Ã³ váº¥n Ä‘á» volume cá»§a sts hay deployment lÃ  khÃ¡ quan trá»ng, volume Ä‘Æ¡n giáº£n chá»‰ lÃ  RWO vá»›i 1 Pod thÃ´i vÃ  nÃ³ cháº¡y Replicate hoáº·c Cluster Sharding tÃ¹y loáº¡i á»©ng dá»¥ng hoáº·c database, tuy nhiÃªn váº¥n Ä‘á» chÃ­nh trong khi triá»ƒn khai sts vá»›i volume Ä‘Ã³ lÃ  Reclaim Policy vÃ  Volume Expansion.
Äáº§u tiÃªn náº¯m rÃµ vá» PV vÃ  PVC trÆ°á»›c, hÃ´m nay mÃ¬nh cÃ³ má»™t anh Ä‘á»“ng nghiá»‡p há»i vá» PV vÃ  PVC khÃ¡c nhau nhÆ° nÃ o, sau Ä‘Ã³ mÃ¬nh Ä‘Æ°a ra Ä‘Ã¡p Ã¡n lÃ  PV sáº½ tham chiáº¿u Ä‘áº¿n disk hoáº·c volume á»Ÿ bÃªn phÃ­a provider, vÃ­ dá»¥ AWS táº¡o ra má»™t EBS thÃ¬ cÃ¡i volume trong EBS Ä‘Ã³ chÃ­nh lÃ  cÃ¡i PV, trong PV sáº½ cÃ³ tham sá»‘ cho ta biáº¿t lÃ  ta Ä‘ang dÃ¹ng "volume nÃ o cá»§a EBS". Váº­y PV lÃ  tham chiáº¿u tá»›i volume cá»§a provider.
CÃ²n PVC lÃ  gÃ¬ ? Sang tá»›i PVC, ta pháº£i Ä‘á»‹nh nghÄ©a Ä‘Æ°á»£c ráº±ng khi má»™t volume Ä‘Æ°á»£c táº¡o ra, nÃ³ cÃ³ thá»ƒ Ä‘Æ°á»£c táº¡o ra nhá» vÃ o PVC + StorageClass, sau Ä‘Ã³ tá»« StorageClass, CSI controller sáº½ táº¡o ra PV tÆ°Æ¡ng á»©ng Ä‘á»ƒ tham chiáº¿u tá»›i cÃ¡i volume tháº­t á»Ÿ bÃªn ngoÃ i provider, vÃ  PVC attach vÃ o cÃ¡i PV. Sau khi cáº£ PV + PVC Ä‘á»u attach thÃ¬ cuá»‘i cÃ¹ng Ä‘á»ƒ PVC hoáº¡t Ä‘á»™ng thá»±c sá»±, nÃ³ pháº£i Ä‘Æ°á»£c attach vÃ o Pod, PVC chá»©a thÃ´ng tin vá» claim, chá»§ yáº¿u bao gá»“m 2 thÃ´ng tin, má»™t lÃ  node selector, hai lÃ  Pod selector, cÃ³ nghÄ©a lÃ  Pod náº±m trÃªn Node nÃ o thÃ¬ cÃ¡i volume kia sáº½ Ä‘Æ°á»£c attach vÃ o node Ä‘Ã³ vÃ  Ä‘á»“ng thá»i cÅ©ng attach Ä‘Æ°á»£c vÃ o Pod Ä‘Ã³ luÃ´n, Ä‘Ã³ chÃ­nh lÃ  PVC.
Váº­y hiá»ƒu Ä‘Æ¡n giáº£n lÃ  PV tham chiáº¿u tá»›i volume ngoÃ i provider. CÃ²n PVC lÃ  tham chiáº¿u tá»›i volume gáº¯n tá»›i node nÃ o vÃ  gáº¯n vÃ o vÃ o pod nÃ o trÃªn node Ä‘Ã³.
Tuy nhiÃªn lÃºc sá»­ dá»¥ng dynamic volume qua StorageClass, Ä‘Ã¢y lÃ  cÃ¡ch phá»• biáº¿n nháº¥t vÃ¬ dá»±a vÃ o Cloud Provider vÃ  CSI thÃ¬ ta chá»‰ cáº§n Ä‘iá»n cÃ¡c thÃ´ng sá»‘ trong PVC + StorageClass Name, cÃ¡c thÃ´ng sá»‘ vá» dung lÆ°á»£ng, IOPS vÃ  FileSystem, but wait !!! PVC tham chiáº¿u Ä‘áº¿n volume á»Ÿ ngoÃ i mÃ , táº¡i sao láº¡i táº¡o PVC vÃ  trá» tá»›i StorageClass lÃ  Ä‘Æ°á»£c luÃ´n mÃ  khÃ´ng pháº£i táº¡o PV trÆ°á»›c nhá»‰ ? Láº¡i quay láº¡i váº¥n Ä‘á» á»Ÿ trÃªn, khi táº¡o PVC vÃ  chá»‰ Ä‘á»‹nh StorageClass thÃ¬ StorageClass sáº½ yÃªu cáº§u CSI táº¡o PV map vá»›i volume bÃªn ngoÃ i luÃ´n.
=> Váº­y thÃ¬ Kubernetes chá»‰ quan tÃ¢m ráº±ng nÃ³ táº¡o volume vÃ  volume claim nhÆ° nÃ o vÃ  Ä‘Ã­ch cuá»‘i Ä‘á»ƒ má»i thá»© hoáº¡t Ä‘á»™ng Ä‘Ã³ lÃ  volume pháº£i Ä‘Æ°á»£c gáº¯n vÃ o Pod.
Káº¿t luáº­n trÃªn cÃ³ Ã½ nghÄ©a nhÆ° nÃ o ? Let go to part 2 -> Volume Expansion
Äáº§u tiÃªn Ä‘á»ƒ giáº£i thÃ­ch rÃµ thÃ¬ ta sáº½ scale sts vá» 0 trÆ°á»›c Ä‘á»ƒ Ä‘áº£m báº£o ráº±ng lÃºc nÃ y Pod = 0 vÃ  volume cÅ©ng sáº½ khÃ´ng Ä‘Æ°á»£c attach vÃ o Node + Pod
PV cÃ³ cÃ¡c tráº¡ng thÃ¡i cáº§n quan tÃ¢m lÃ  Released, Bound vÃ  Available, khi PV Ä‘Æ°á»£c táº¡o, Ä‘Æ°á»£c PVC attach thÃ¬ nÃ³ Ä‘ang Ä‘Æ°á»£c Bound, tuy nhiÃªn trong trÆ°á»ng há»£p PVC bá»‹ unattach khá»i PV vá»›i Ä‘iá»u kiá»‡n lÃ  StorageClass cÃ³ Reclaim Policy = Retain, lÃºc nÃ y PV váº«n cÃ²n. PV gáº¯n vá»›i volume tháº­t bÃªn ngoÃ i, váº­y suy ra volume tháº­t váº«n cÃ²n, lÃºc nÃ y khi PVC bá»‹ unattach khá»i PV thÃ¬ PV chuyá»ƒn sang tráº¡ng thÃ¡i Available.
Trong tráº¡ng thÃ¡i nÃ y, ta cÃ³ thá»ƒ edit PV vÃ  resize nÃ³ vÃ  khi get láº¡i thÃ¬ nÃ³ Ä‘Ã£ update thÃ nh cÃ´ng vÃ  hiá»‡n dung lÆ°á»£ng resize nhÆ° mong muá»‘n, vÃ­ dá»¥ resize PV tá»« 6Gi lÃªn 8Gi, tuy nhiÃªn khi kiá»ƒm tra láº¡i ngoÃ i volume nÃ³ váº«n y nguyÃªn vÃ  tháº­m chÃ­ cháº³ng cÃ³ event nÃ o Ä‘Æ°á»£c gá»­i Ä‘áº¿n Provider Ä‘á»ƒ request tÄƒng dung lÆ°á»£ng (capacity) lÃªn cáº£.
LÃºc nÃ y mÃ¬nh sáº½ edit PV Ä‘á»ƒ xÃ³a claim cÅ© vÃ  táº¡o láº¡i PVC rá»“i gáº¯n láº¡i vÃ o PVC Ä‘Ã³ sau Ä‘Ã³ resize tiáº¿p PVC tá»« 6Gi lÃªn 8Gi cho nÃ³ Ä‘á»“ng bá»™ Ä‘á»ƒ xem volume ngoÃ i cÃ³ tÄƒng khÃ´ng ? Oh shit, Káº¿t quáº£ lÃ  nÃ³ váº«n giá»¯ nguyÃªn vÃ  chÆ°a tÄƒng Ä‘Æ°á»£c .....
Sau khi scale sts vá» 0 Pod vÃ  tÄƒng PV + PVC thÃ¬ chÃºng Ä‘á»u khÃ´ng effect vÃ  cháº³ng cÃ³ gÃ¬ xáº£y ra cáº£, váº­y náº¿u scale sts láº¡i lÃªn 1 thÃ¬ lÃºc nÃ y PVC Ä‘Ã£ Ä‘Æ°á»£c "claim" láº¡i tá»›i Pod vÃ  Node chá»©a Pod Ä‘Ã³, Tuy nhiÃªn lÃºc nÃ y chÃºng cÃ³ thá»ƒ bÃ¡o lá»—i ráº±ng PVC hiá»‡n táº¡i khÃ´ng Ä‘á»“ng nháº¥t vá»›i PV hoáº·c náº¿u scale láº¡i Pod lÃªn Ä‘Æ°á»£c thÃ¬ dung lÆ°á»£ng váº«n y nguyÃªn nhÆ° váº­y cháº³ng cÃ³ gÃ¬ xáº£y ra.
Káº¾T LUáº¬N
PV vÃ  PVC vÃ  Deployment/StatefulSet hoáº¡t Ä‘á»™ng cháº·t cháº½ vá»›i nhau, má»¥c Ä‘Ã­ch chÃ­nh sinh ra lÃ  Ä‘á»ƒ táº¡o ra volume cho Pod, Pod chá»‰ hiá»ƒu Volume Ä‘Ã³ náº¿u nÃ³ Ä‘Æ°á»£c gáº¯n vÃ o Disk, viá»‡c gáº¯n vÃ o Disk hay khÃ´ng lÃ  do PVC + Pod pháº£i Ä‘Æ°á»£c up lÃªn.
Táº¡i sao scale láº¡i khÃ´ng hoáº¡t Ä‘á»™ng khi PVC khÃ´ng attach vÃ o Pod ? Bá»Ÿi vÃ¬ cÃ¡c Node trong Kubernetes chá»‰ hiá»ƒu volume khi nÃ³ Ä‘Æ°á»£c attach vÃ o Node, Cloud Provider quáº£n lÃ½ volume, vÃ  thá»ƒ hiá»‡n trÃªn Kubernetes qua resource lÃ  PV, PV chá»‰ tham chiáº¿u ráº±ng Ä‘áº¿n volume Ä‘Ã³ vÃ  cÃ³ má»™t cÃ¡i liÃªn quan tá»›i StorageClass, náº¿u PV táº¡o ra tá»« StorageClass Ä‘Ã³ lÃ  Reclaim Policy, nghÄ©a lÃ  PV bá»‹ "zombie", khÃ´ng cÃ³ PVC hoáº·c PVC gáº¯n vá»›i nÃ³ bá»‹ xÃ³a thÃ¬ nÃ³ sáº½ bá»‹ delete náº¿u policy = delete, cÃ²n khÃ´ng thÃ¬ nÃ³ sáº½ retain vÃ  náº¿u PV Ä‘ang bá»‹ "zombie" thÃ¬ nÃ³ sáº½ "Availble" Ä‘á»ƒ tháº±ng PVC khÃ¡c "Bound" láº¡i.
Suy ra PV chá»‰ thá»ƒ hiá»‡n tráº¡ng thÃ¡i cá»§a volume bÃªn ngoÃ i, dung lÆ°á»£ng cá»§a nÃ³ phá»¥ thuá»™c vÃ o PVC.
VÃ¬ Volume trong Kubernetes phá»¥c vá»¥ cho Pod, Pod thá»ƒ hiá»‡n nÃ³ cáº§n cÃ¡i gÃ¬ vÃ  cáº§n tá»« Ä‘Ã¢u qua PVC, PVC thá»ƒ hiá»‡n dung lÆ°á»£ng cáº§n tá»« volume ngoÃ i (PV) vÃ  bÃªn trong cho Pod, Khi PVC gáº¯n vÃ o má»™t Pod Ä‘ang cháº¡y cÅ©ng Ä‘á»“ng nghÄ©a vá»›i viá»‡c Volume Ä‘Æ°á»£c gáº¯n vÃ o Node, khi Volume gáº¯n vÃ o Node thÃ¬ Kubernetes má»›i hiá»ƒu vÃ  má»›i quyáº¿t Ä‘á»‹nh hÃ nh Ä‘á»™ng Volume Expansion, vÃ¬ nÃ³ chá»‰ quáº£n lÃ½ nhá»¯ng gÃ¬ cÃ³ bÃªn trong cá»¥m, váº­y nÃªn ngÆ°á»i ta hay tÄƒng PVC chá»© khÃ´ng bao giá» tÄƒng PV, vÃ¬ PVC tham chiáº¿u tá»›i Volume gáº¯n vÃ o Node vÃ  Pod nÃªn tÄƒng dung lÆ°á»£ng á»Ÿ PVC má»›i cÃ³ Ã½ nghÄ©a thá»±c sá»±.
Khi tÄƒng PVC thÃ¬ PV cÅ©ng sáº½ tÄƒng theo, Ä‘iá»u Ä‘Ã³ cÃ³ nghÄ©a ráº±ng Cloud Provider phá»¥c vá»¥ theo nhu cáº§u cá»§a Pod bÃªn trong Kubernetes, náº¿u nÃ³ Ä‘ang Ä‘Æ°á»£c attach vÃ o volume vÃ  yÃªu cáº§u tÄƒng, OK tÃ´i sáº½ tÄƒng cho Ã´ng, tuy nhiÃªn Ã´ng khÃ´ng Ä‘Æ°á»£c attach nhÆ°ng láº¡i gá»­i yÃªu cáº§u tÄƒng tá»« PV Ä‘ang bá»‹ "zombie" tÃ´i sáº½ khÃ´ng tÄƒng cho Ã´ng.
Pháº§n nÃ y mÃ¬nh xin phÃ©p viáº¿t demo vÃ  sáº½ cÃ³ má»™t bÃ i deep dive sÃ¢u hÆ¡n Ä‘á»ƒ má»i ngÆ°á»i cÃ¹ng hiá»ƒu, táº¡m viáº¿t draft trÆ°á»›c nhÆ° nÃ y Ä‘Ã£ ğŸ˜ƒ